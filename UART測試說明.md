# ESP8266 SoftwareSerial UART配置測試

## 🎯 測試目標

驗證ESP8266的SoftwareSerial配置是否能正確與LD2412雷達傳感器通信：
- **RX = GPIO15** - 接收LD2412的TX數據
- **TX = GPIO2 (UART1_TXD)** - 發送命令到LD2412的RX
- **OUT = GPIO13** - 讀取LD2412的數位檢測信號

## 🔧 硬體接線

```
ESP8266-12F    LD2412
-----------    ------
3.3V      ->   VCC
GND       ->   GND
GPIO15    ->   TX (LD2412發送數據)
GPIO2     ->   RX (LD2412接收命令)
GPIO13    ->   OUT (數位檢測輸出)
```

## 📋 測試程序功能

### 1. UART配置驗證
- 測試SoftwareSerial(15, 2)初始化
- 驗證GPIO15接收功能
- 驗證GPIO2發送功能
- 測試多種波特率（256000, 115200）

### 2. 通信協議測試
- 發送LD2412標準命令
- 檢查命令回應
- 驗證數據幀格式
- 統計通信成功率

### 3. 數據解析驗證
- 識別數據幀頭尾 (`F4F3F2F1` ... `F8F7F6F5`)
- 解析目標狀態位
- 提取距離和能量數據
- 驗證數據完整性

## 🚀 使用方法

### 步驟1：上傳測試程序
```bash
# 執行自動上傳腳本
./upload_uart_test.sh
```

或手動上傳：
```bash
# 備份當前程序
cp src/main.cpp src/main.cpp.backup

# 部署測試程序
cp src/uart_test.cpp src/main.cpp

# 編譯上傳
pio run -e esp12e -t upload
```

### 步驟2：監控測試結果
```bash
# 監控串列埠輸出
pio device monitor -b 115200

# 或使用Python腳本
python3 test_raw_data.py
```

### 步驟3：恢復原程序
```bash
# 恢復備份的程序
cp src/main.cpp.backup src/main.cpp
pio run -e esp12e -t upload
```

## 📊 預期測試輸出

### 成功的輸出範例：
```
==========================================
    ESP8266 SoftwareSerial UART測試      
    RX=GPIO15, TX=GPIO2 配置驗證         
==========================================

=== UART配置測試 ===
GPIO配置:
  RX (接收) = GPIO15
  TX (發送) = GPIO2 (UART1_TXD)
  OUT (數字) = GPIO13

1. 測試波特率: 256000
測試波特率 256000...
  收到字節數: 45
  ✅ UART通信正常

2. 測試波特率: 115200
測試波特率 115200...
  收到字節數: 38
  ✅ UART通信正常

=== LD2412初始化 ===
1. 進入配置模式
發送命令: 進入配置模式
16進制: FD FC FB FA 04 00 FF 00 01 00 04 03 02 01
回應: FD FC FB FA 04 00 FF 01 00 00 04 03 02 01

=== 數據幀 #1 ===
位置: 0x0000 - 0x0014
長度: 21 字節
完整幀: F4 F3 F2 F1 0B 00 02 AA 02 00 00 00 28 00 64 55 00 F8 F7 F6 F5

--- 數據幀詳細分析 ---
目標狀態：0x02 (移動目標)
移動目標距離：0 cm
靜止目標距離：40 cm
檢測距離：85 cm

==========================================
        UART通信測試統計報告             
==========================================
運行時間：15 秒
總接收字節：156
有效數據幀：8
OUT腳狀態：HIGH
平均接收速率：10.40 字節/秒
平均幀率：0.53 幀/秒

--- UART配置驗證 ---
✅ SoftwareSerial接收正常
✅ GPIO15(RX)配置正確
✅ LD2412數據幀格式正確
✅ 通信協議正常
==========================================
```

## 🔍 問題診斷

### 如果沒有收到數據：
```
❌ SoftwareSerial接收異常
❌ 可能的問題:
   - GPIO15接線錯誤
   - LD2412未正確連接
   - 波特率不匹配
   - LD2412未供電
```

**解決方案**：
1. 檢查接線是否正確
2. 確認LD2412供電（3.3V）
3. 用萬用表測量GPIO15是否有電平變化
4. 嘗試不同波特率

### 如果收到數據但無有效幀：
```
⚠️ 接收到數據但無有效幀
⚠️ 可能需要檢查數據格式
```

**解決方案**：
1. 檢查LD2412是否為正確型號
2. 確認數據幀格式是否匹配
3. 檢查串列埠設定（8N1）
4. 嘗試重新初始化LD2412

## 🎯 測試判斷標準

### ✅ 測試成功標準：
- SoftwareSerial初始化成功
- 能收到LD2412回應數據
- 識別到正確的數據幀格式
- 目標狀態解析正確
- 距離數據合理（0-800cm）

### ❌ 測試失敗標準：
- 完全無數據接收
- 數據格式不符合LD2412協議
- 大量數據但無有效幀
- GPIO13狀態異常

## 🔧 進階調試

### 1. 示波器測試
如果有示波器，可以測量：
- GPIO15的數據波形
- GPIO2的命令波形
- 波特率是否準確

### 2. 邏輯分析儀
使用邏輯分析儀捕獲：
- 完整的UART通信過程
- 命令和回應的時序
- 數據幀的完整性

### 3. 替代測試
- 使用USB轉TTL直接連接LD2412
- 對比ESP8266轉發和直接連接的差異
- 驗證LD2412本身是否正常工作

## 📝 測試報告模板

```
ESP8266 SoftwareSerial UART測試報告
=====================================
測試日期: ____年____月____日
測試人員: ________________

硬體配置:
- ESP8266型號: ESP8266-12F
- LD2412型號: ____________
- 供電電壓: 3.3V
- 接線檢查: □正確 □錯誤

測試結果:
- UART初始化: □成功 □失敗
- 數據接收: □成功 □失敗
- 幀格式驗證: □成功 □失敗
- 協議解析: □成功 □失敗

統計數據:
- 測試時間: _____ 秒
- 接收字節: _____ 字節
- 有效幀數: _____ 幀
- 平均幀率: _____ 幀/秒

結論:
□ 配置正確，通信正常
□ 配置有問題，需要調整
□ 硬體故障，需要檢修

備註:
_________________________________
_________________________________
```

---

**測試程序版本**: v1.0  
**適用硬體**: ESP8266-12F + LD2412  
**最後更新**: 2024年1月 